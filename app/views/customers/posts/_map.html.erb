<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['API_KEY']%>&callback=initMap" async defer></script>

<script>
  function initMap() {
    const mapElement = document.getElementById("map");
    let map = null;
    let marker = [];

    const initialLocation = { lat: 35.6895, lng: 139.6917 };
    map = new google.maps.Map(mapElement, {
      center: initialLocation,
      zoom: 10,
    });

    // @post.location = "宮沢賢治記念館,宮沢賢治記念館2"
    const locationArray = "<%= @post.location %>".split(',');
    // locationArray ["宮沢賢治記念館","宮沢賢治記念館2"]
    const geocoder = new google.maps.Geocoder();

    locationArray.forEach(function(location) {
      geocoder.geocode({ address: location }, function(results, status) {
        if (status === "OK") {
          const locationLatLng = results[0].geometry.location;
          marker.push(
            new google.maps.Marker({
                position: locationLatLng,
                map: map,
              })
          );
          map.setCenter(locationLatLng);
          map.setZoom(15);
        } else {
          console.error("Geocode was not successful for the following reason: " + status);
        }
      });
    });

  }

  document.addEventListener("DOMContentLoaded", function() {
    initMap();
  });
</script>


<!--<script>-->
<!--  function geocodeLocation(geocoder, location) {-->
<!--    return new Promise((resolve, reject) => {-->
<!--      geocoder.geocode({ address: location }, function(results, status) {-->
<!--        if (status === google.maps.GeocoderStatus.OK) {-->
<!--          const locationLatLng = results[0].geometry.location;-->
<!--          resolve(locationLatLng);-->
<!--        } else {-->
<!--          console.error("Geocode was not successful for the following reason: " + status);-->
<!--          reject(status);-->
<!--        }-->
<!--      });-->
<!--    });-->
<!--  }-->

<!--  function initMap() {-->
<!--    const mapElement = document.getElementById("map");-->
<!--    const initialLocation = { lat: 35.6895, lng: 139.6917 };-->
<!--    const map = new google.maps.Map(mapElement, {-->
<!--      center: initialLocation,-->
<!--      zoom: 10,-->
<!--    });-->

    <!--const locations =  @post.locations.to_json.html_safe || [] %>; // サーバーから地名の配列を取得-->

<!--    const geocoder = new google.maps.Geocoder();-->

<!--    if (Array.isArray(locations)) {-->
<!--      locations.forEach(function(location) {-->
<!--        geocodeLocation(geocoder, location)-->
<!--          .then(function(locationLatLng) {-->
<!--            const marker = new google.maps.Marker({-->
<!--              position: locationLatLng,-->
<!--              map: map,-->
<!--            });-->
            <!--map.fitBounds(marker.getBounds()); // ピンを表示した後に自動的にズーム-->
<!--          })-->
<!--          .catch(function(error) {-->
<!--            console.error("Geocode was not successful for the following reason: " + error);-->
<!--          });-->
<!--      });-->
<!--    }-->
<!--  }-->

<!--  document.addEventListener("DOMContentLoaded", function() {-->
<!--    initMap();-->
<!--  });-->
<!--</script>-->